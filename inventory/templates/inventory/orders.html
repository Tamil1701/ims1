{% extends 'inventory/base.html' %}
{% block title %}{{ title }}{% endblock %}
{% load crispy_forms_tags %}
{% block content %}
<!-- <style>
  /* Define custom styles for the order status column */
  .order-status-cell {
    padding: 10px; /* Add padding to create space inside the cell */
    border-radius: 5px; /* Add border radius for rounded corners */
  }
</style> -->
<br>
<br>
<div class="container">
  <div class="container">
    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-body">
            <h2 class="card-title">Low Stock Products</h2>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in low_stock_products %}
                  <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ product.quantity }}</td>
                    <td><span class="badge bg-warning text-dark">Low Stock</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
  
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-body">
            <h2 class="card-title">Out of Stock Products</h2>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in out_of_stock_products %}
                  <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ product.quantity }}</td>
                    <td><span class="badge bg-danger">Out of Stock</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</div>
<div class="container">
  <div class="row">
    <div class="col-md-8">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Ordered Product</th>
            <th scope="col">Created by</th>
            <th scope="col">Quantity</th>
            <th scope="col">Seller</th>
            <th scope="col">Order Date</th>
            <th scope="col">Order Status</th>
            <th scope="col">Change Status</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr class="order-row" data-order-id="{{ order.id }}">
            <td>{{ order.product }}</td>
            <td>{{ order.created_by.username }}</td>
            <td>{{ order.order_quantity }}</td>
            <td title="{% if order.seller == 'seller1' %}Seller 1 - Address 1{% elif order.seller == 'seller2' %}Seller 2 - Address 2{% elif order.seller == 'seller3' %}Seller 3 - Address 3{% endif %}">
              {{ order.seller }}
            </td>
            <td>{{ order.date }}</td>
            <td>{{ order.get_order_status_display }}</td>
            <td>
              <select class="order-status-select order-status-cell">
                {% for status in order.ORDER_STATUS_CHOICES %}
                    <option value="{{ status.0 }}" {% if order.order_status == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                {% endfor %}
            </select>
            </td>
            
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="col-md-4">
      <form method="POST">
        <h4>Create a New Order</h4>
        <hr>
        {% csrf_token %}
        {{ form|crispy }}
        <br>
        <button type="submit" class="btn btn-primary">Create Order</button>
      </form>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Function to display order details in a popup
  function displayOrderDetails(orderId) {
    // AJAX request to fetch order details
    $.ajax({
      type: 'GET',
      url: `/get_order_details/${orderId}/`,  // URL to fetch order details
      success: function(response) {
        // Construct HTML content for order details (excluding invoice status)
        var orderDetailsHTML = `
          <div style="padding: 20px; border: 1px solid #ccc;">
            <h2>Order Details</h2>
            <p><strong>Ordered Product:</strong> ${response.product}</p>
            <p><strong>Ordered by:</strong> ${response.created_by}</p>
            <p><strong>Quantity:</strong> ${response.order_quantity}</p>
            <p><strong>Seller:</strong> ${response.seller}</p>
            <p><strong>Order Date:</strong> ${response.date}</p>
            <p><strong>Order Status:</strong> ${response.order_status}</p>
            <button onclick="window.print()">Print</button>
          </div>
        `;

        // Open a new popup window and set its content
        var popupWindow = window.open('', '_blank', 'width=600,height=400');
        popupWindow.document.body.innerHTML = orderDetailsHTML;
        // popupWindow.print();
      },
      error: function(xhr, status, error) {
        // Handle error response
        alert('Failed to fetch order details. Please try again.');
      }
    });
  }
  function printOrderDetails() {
    // Trigger the print dialog for the popup window
    window.print();
    console.log('Printing order details...');
  }

  // Function to handle click event on order rows
  $(document).ready(function() {
    // Attach click event to order rows except for order status dropdowns
    $('.order-row').click(function(event) {
      // Check if the click target is not the order status dropdown
      if (!$(event.target).is('select.order-status-select')) {
        var orderId = $(this).data('order-id');
        displayOrderDetails(orderId); // Display order details in popup
      }
    });
    $(document).ready(function() {
    // Attach change event to order status dropdowns
    $('.order-status-select').change(function() {
        var newStatus = $(this).val();
        var orderId = $(this).closest('.order-row').data('order-id');

        // Obtain the CSRF token from the cookie
        var csrftoken = getCookie('csrftoken');

        // Make AJAX request to update order status
        $.ajax({
            type: 'POST',
            url: `/update_order_status/${orderId}/`,  // URL to update order status
            data: {
                new_status: newStatus
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', csrftoken);  // Set CSRF token in the request header
            },
            success: function(response) {
                if (response.success) {
                    // Show success message or update UI
                    alert(`Order status updated to '${newStatus}' successfully.`);
                } else {
                    alert('Failed to update order status.');
                }
            },
            error: function(xhr, status, error) {
                // Handle error response
                alert('Failed to update order status. Please try again.');
            }
        });
    });

    $(document).ready(function() {
    // Function to style order status text
    function styleOrderStatus() {
      $('.order-status-cell').each(function() {
        var orderStatusText = $(this).text().trim(); // Get order status text

        // Determine color and font weight based on order status
        var color, fontWeight;
        switch (orderStatusText) {
          case 'Pending':
            color = 'orange';
            fontWeight = 'bold';
            break;
          case 'Completed':
            color = 'green';
            fontWeight = 'bold';
            break;
          case 'Canceled':
            color = 'red';
            fontWeight = 'bold';
            break;
          default:
            color = 'black'; // Default color
            fontWeight = 'normal'; // Default font weight
            break;
        }

        // Apply styling to order status text
        $(this).css({
          'color': color,
          'font-weight': fontWeight
        });
      });
    }

    // Call the function to style order status text on page load
    styleOrderStatus();
  });

  function updateOrderStatus(selectElement, orderId) {
    var selectedStatus = selectElement.value;
    var orderRow = document.getElementById('order-row-' + orderId);

    // Set background color and font weight based on the selected status
    if (selectedStatus === 'pending') {
      orderRow.style.backgroundColor = 'lightblue';
    } else if (selectedStatus === 'completed') {
      orderRow.style.backgroundColor = 'lightgreen';
    } else if (selectedStatus === 'canceled') {
      orderRow.style.backgroundColor = 'lightcoral';
    }

    // Make text bold for better visibility
    orderRow.style.fontWeight = 'bold';

    // You can also make an AJAX request to update the order status in the backend
    // Here, you can implement the logic to send the updated status to the server
    // using a Django view or API endpoint.
  }
  //   $(document).ready(function() {
  //   // Function to style order status cells based on status value
  //   function styleOrderStatusCells() {
  //     $('.order-status-cell').each(function() {
  //       var orderStatus = $(this).text().trim(); // Get the order status value
  //       var backgroundColor;

  //       // Set background color based on order status
  //       if (orderStatus === 'pending') {
  //         backgroundColor = 'orange';
  //       } else if (orderStatus === 'completed') {
  //         backgroundColor = 'green';
  //       } else if (orderStatus === 'canceled') {
  //         backgroundColor = 'red';
  //       } else {
  //         backgroundColor = 'white'; // Default background color
  //       }

  //       // Apply styling to the order status cell
  //       $(this).css({
  //         'padding': '10px',
  //         'border-radius': '5px',
  //         'background-color': backgroundColor
  //       });
  //     });
  //   }

  //   // Call the function to style order status cells on page load
  //   styleOrderStatusCells();
  // });
});

// Function to get the CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Check if the cookie name matches the expected format
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}



    
  
});

    
 
</script>






{% endblock %}
